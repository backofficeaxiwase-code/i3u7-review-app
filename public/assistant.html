<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIã‚¯ãƒã‚³ãƒŸä½œæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ | i3u7</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #f8f9fa;
            --text-main: #2d2d2d;
            --primary: #c5a028;
            /* Gold accent */
            --primary-light: #fcf6da;
            --border-radius: 12px;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            padding-bottom: 20px;
        }

        .header {
            background: #222;
            color: #d4af37;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 16px;
            letter-spacing: 1px;
        }

        .step-container {
            padding: 24px;
            display: none;
            /* Hidden by default, JS toggles it */
        }

        .step-container.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .question-block {
            margin-bottom: 32px;
        }

        .q-label {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            display: block;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
        }

        .q-sub {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
            display: block;
            margin-top: -8px;
        }

        /* Radio Buttons (Cards) for Context */
        .radio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .context-radio {
            display: none;
        }

        .context-label {
            display: block;
            padding: 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .context-radio:checked+.context-label {
            background: var(--primary-light);
            border-color: var(--primary);
            color: #8a6d00;
            font-weight: bold;
        }

        /* Checkboxes for Features */
        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feature-check {
            display: none;
        }

        .feature-label {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            background: #fff;
        }

        .feature-label:hover {
            background: #fafafa;
        }

        .check-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .check-circle::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            display: none;
        }

        .feature-check:checked+.feature-label {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .feature-check:checked+.feature-label .check-circle {
            border-color: var(--primary);
        }

        .feature-check:checked+.feature-label .check-circle::after {
            display: block;
        }

        /* Free Text */
        textarea.free-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            min-height: 80px;
            box-sizing: border-box;
        }

        /* Action Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 16px;
        }

        .btn-primary {
            background: #222;
            color: #d4af37;
        }

        .btn-secondary {
            background: #fff;
            border: 1px solid #ddd;
            color: #444;
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn-row .btn {
            margin-top: 0;
        }

        /* Loading */
        .loading {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #eee;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>REVIEW ASSISTANT</h1>
        </div>

        <!-- STEP 1: Context -->
        <div id="step-1" class="step-container active">
            <div class="question-block">
                <span class="q-label">Q1. ä»Šå›ã®åˆ©ç”¨ã‚·ãƒ¼ãƒ³ã¯ï¼Ÿ</span>
                <div class="radio-grid">
                    <label>
                        <input type="radio" name="context" value="ä¸€äººã§ãƒªãƒ©ãƒƒã‚¯ã‚¹" class="context-radio" checked>
                        <span class="context-label">ğŸ‘¤ ã²ã¨ã‚Šã§<br>ã˜ã£ãã‚Š</span>
                    </label>
                    <label>
                        <input type="radio" name="context" value="ã‚«ãƒƒãƒ—ãƒ«ã§ãƒ‡ãƒ¼ãƒˆ" class="context-radio">
                        <span class="context-label">ğŸ’‘ ã‚«ãƒƒãƒ—ãƒ«ãƒ»<br>å¤«å©¦ã§</span>
                    </label>
                    <label>
                        <input type="radio" name="context" value="å‹äººã¨æ¥½ã—ã" class="context-radio">
                        <span class="context-label">ğŸ‘¯â€â™€ï¸ å‹äººã¨<br>æ¥½ã—ã</span>
                    </label>
                    <label>
                        <input type="radio" name="context" value="ä»•äº‹ã®åˆé–“ã«" class="context-radio">
                        <span class="context-label">ğŸ’¼ ä»•äº‹ã®<br>åˆé–“ã«</span>
                    </label>
                </div>
                <button class="btn btn-primary" onclick="nextStep(2)">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <!-- STEP 2: Features -->
        <div id="step-2" class="step-container">
            <div class="question-block">
                <span class="q-label">Q2. ç‰¹ã«è‰¯ã‹ã£ãŸç‚¹ã¯ï¼Ÿ</span>
                <span class="q-sub">è¤‡æ•°é¸æŠå¯ã€‚ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãã®è©±é¡ŒãŒæ–‡ç« ã«å…¥ã‚Šã¾ã™ã€‚</span>
                <div class="feature-list">
                    <label>
                        <input type="checkbox" name="features" value="ã‚»ãƒ«ãƒ•ãƒ­ã‚¦ãƒªãƒ¥" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸ”¥ ã‚»ãƒ«ãƒ•ãƒ­ã‚¦ãƒªãƒ¥
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="æ°´é¢¨å‘‚" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸ’§ æ°´é¢¨å‘‚ï¼ˆå†·ãŸã„ï¼ï¼‰
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ãƒã‚§ã‚¢" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸª‘ ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ãƒã‚§ã‚¢
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="ReFaãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>âœ¨ ReFaãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼/ã‚·ãƒ£ãƒ¯ãƒ¼
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="BluetoothéŸ³æ¥½" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸµ BluetoothéŸ³æ¥½
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="å®Œå…¨éå¯¾é¢" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸ”‘ å…¥é€€å®¤ãŒã‚¹ãƒ ãƒ¼ã‚º
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="æ‰‹ã¶ã‚‰åˆ©ç”¨" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸ‘œ æ‰‹ã¶ã‚‰ã§OK
                        </span>
                    </label>
                    <label>
                        <input type="checkbox" name="features" value="é§…è¿‘" class="feature-check">
                        <span class="feature-label">
                            <div class="check-circle"></div>ğŸš‰ å¯Œå±±é§…è¿‘
                        </span>
                    </label>
                </div>
                <div class="btn-row" style="margin-top:24px;">
                    <button class="btn btn-secondary" onclick="nextStep(1)">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" onclick="nextStep(3)">æ¬¡ã¸é€²ã‚€</button>
                </div>
            </div>
        </div>

        <!-- STEP 3: Message & Generation -->
        <div id="step-3" class="step-container">
            <div class="question-block">
                <span class="q-label">Q3. å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</span>
                <span class="q-sub">ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®ä¸€è¨€ã‚„å€‹äººçš„ãªæ„Ÿæƒ³ãŒã‚ã‚Œã°ã€‚<br>ï¼ˆAIãŒã“ã®å†…å®¹ã‚’æ•´ãˆã¦æ–‡ç« ã«å…¥ã‚Œã¾ã™ï¼‰</span>
                <textarea id="freeMessage" class="free-input" placeholder="ä¾‹ï¼šæœ€é«˜ã§ã—ãŸï¼ã¾ãŸæ¥ã¾ã™ã€‚"></textarea>

                <div class="btn-row" style="margin-top:24px; flex-direction: column-reverse;">
                    <button class="btn btn-secondary" onclick="nextStep(2)">æˆ»ã‚‹</button>
                    <button id="generateBtn" class="btn btn-primary">AIã§æ–‡ç« ã‚’ä½œæˆã™ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- STEP 4: Result -->
        <div id="step-result" class="step-container">
            <div class="question-block">
                <span class="q-label">ğŸ‰ æ–‡ç« ãŒã§ãã¾ã—ãŸ</span>
                <p style="font-size:13px; color:#666;">å†…å®¹ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„</p>
                <textarea id="resultText" class="free-input" style="min-height:150px; margin-bottom:12px;"></textarea>

                <button id="copyBtn" class="btn btn-primary" style="margin-bottom:12px">ã‚³ãƒ”ãƒ¼ã—ã¦Googleãƒãƒƒãƒ—ã¸</button>
                <button id="retryBtn" class="btn btn-secondary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top:16px; font-weight:bold; color:#444;">AIãŒåŸ·ç­†ä¸­...</p>
        </div>

    </div>

    <script>
        // Global Config
        let GMAP_URL = "https://maps.google.com"; // Fallback

        // Load URL from Backend
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                if (data.gmapUrl) GMAP_URL = data.gmapUrl;
            })
            .catch(console.error);

        // Navigation Logic
        function nextStep(stepNum) {
            document.querySelectorAll('.step-container').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none'; // Force hide
            });

            const target = document.getElementById('step-' + stepNum);
            if (target) {
                target.style.display = 'block';
                // Slight delay to allow display:block to render before opacity transition if wanted, 
                // but simple display:block is enough for now.
                setTimeout(() => target.classList.add('active'), 10);
                window.scrollTo(0, 0);
            }

            // Use 'step-result' special case handled in generate callback
        }

        const generateBtn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');
        const resultText = document.getElementById('resultText');
        const copyBtn = document.getElementById('copyBtn');
        const retryBtn = document.getElementById('retryBtn');

        generateBtn.addEventListener('click', async () => {
            const context = document.querySelector('input[name="context"]:checked').value;
            const features = Array.from(document.querySelectorAll('input[name="features"]:checked')).map(e => e.value);
            const freeMessage = document.getElementById('freeMessage').value;

            if (features.length === 0 && !freeMessage) {
                if (!confirm("è‰¯ã‹ã£ãŸç‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ã“ã®ã¾ã¾ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            }

            loading.style.display = 'flex';

            try {
                const res = await fetch("/api/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        context,
                        features,
                        freeMessage
                    })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    let errMsg = `API Error: ${res.status}`;
                    try {
                        const json = JSON.parse(errText);
                        if (json.error) errMsg = json.error;
                    } catch (e) {
                        errMsg += `\n${errText}`;
                    }
                    throw new Error(errMsg);
                }
                const data = await res.json();

                resultText.value = data.text;

                // Go to Result
                document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step-container').forEach(el => el.style.display = 'none');

                const resultStep = document.getElementById('step-result');
                resultStep.style.display = 'block';
                setTimeout(() => resultStep.classList.add('active'), 10);
                window.scrollTo(0, 0);

            } catch (e) {
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${e.message}\n\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);
                console.error(e);
            } finally {
                loading.style.display = 'none';
            }
        });

        copyBtn.addEventListener('click', () => {
            if (!resultText.value) return;
            const doCopy = () => {
                alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Googleãƒãƒƒãƒ—ãŒé–‹ãã¾ã™ã€‚");
                window.location.href = GMAP_URL;
            };

            if (navigator.clipboard) {
                navigator.clipboard.writeText(resultText.value)
                    .then(doCopy)
                    .catch(() => {
                        // Fail over
                        resultText.select();
                        document.execCommand('copy');
                        doCopy();
                    });
            } else {
                resultText.select();
                document.execCommand('copy');
                doCopy();
            }
        });

        retryBtn.addEventListener('click', () => {
            location.reload();
        });
    </script>

</body>

</html>